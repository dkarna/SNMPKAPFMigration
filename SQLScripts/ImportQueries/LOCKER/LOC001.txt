--select top 1 * from LockerMaster where BranchCode <> 0 and LockerCode <> ''
--select top 1 * from LockerAuth
--select top 1 * from ClientTable

select * from
(
	select
	  M.BranchCode SOL_ID
	, cif.ClientCode Cif_Id
	, M.Name Customer_Name
	, M.SizeCode Locker_Type
	, M.LockerCode Locker_No
	, stuff ((select '/' + AuthName from LockerAuth a where a.BranchCode = M.BranchCode and a.LockerCode = M.LockerCode 
	  for xml path('')),1,1,'') Joint_Holder_Name1
	, NULL Joint_Holder_Cif_Id1
	, NULL Joint_Holder_Relation1
	, NULL Joint_Holder_Name2
	, NULL Joint_Holder_Cif_Id2
	, NULL Joint_Holder_Relation2
	, NULL Joint_Holder_Name3
	, NULL Joint_Holder_Cif_Id3
	, NULL Joint_Holder_Relation3
	, M.Nominee Opacc
	, NULL Sdacc
	, M.KeyNo Code_Word
	, convert(varchar(10),isnull(M.EnteredDate,'01-01-1900'),105) as Open_Date
	, convert(varchar(10),isnull(M.ReleaseDate,'01-01-1900'),105) as Closed_Date
	, 'Yr' Frequency
	, M.Rent Total_Rent
	, M.Remarks Remarks
	, convert(varchar(10),isnull(M.EnteredDate,'01-01-1900'),105) Last_Rent_Date
	, convert(varchar(10),dateadd(year,1,M.EnteredDate),105) as Due_Date
	, NULL Due_notice_Date
	, RIGHT(SPACE(17)+CAST('0' AS VARCHAR(17)),17) Due_Rent
	, 'N' Delete_Flag
	, stuff((select '/' + Remarks from LockerAuth a where a.BranchCode = M.BranchCode and a.LockerCode = M.LockerCode
	  for xml path('')),1,1,'' ) Free_Text1
	, NULL Free_Text2
	, 'T' Payment_Mode
	, convert(varchar(10),dateadd(year,1,M.EnteredDate),105) as Payment_Date
	, NULL Rent_Paid
	, NULL Preferable_Language_Code
	, NULL Customer_Name_in_Pref_Lang_Code
	, case when A.LockerCode is not null then 'ANY1S' else 'SNGLE' end Mode_of_oper_code 
	from LockerMaster M 
	join Master cif  on cif.MainCode = M.Nominee and cif.BranchCode = M.BranchCode
	left join LockerAuth A
	--left join (select top 1 LockerCode , BranchCode from LockerAuth) A 
	on A.LockerCode = M.LockerCode and A.BranchCode = M.BranchCode 
	where M.BranchCode<>'0'
	and M.LockerCode<>''
	and LEFT(cif.ClientCode , 1) <>'_'
	and cif.IsBlocked NOT IN ('C','o')
	and len(cif.MainCode) >= 8
	and (Nominee<> '9710100' or Nominee <> null)
	AND EXISTS
	(
		SELECT 1 FROM AcCustType WHERE MainCode = cif.MainCode and CustTypeCode = 'Z' and CustType IN ('11','12')
	) 
	
	UNION

	select
	  M.BranchCode SOL_ID
	, cif.ClientCode Cif_Id
	, M.Name Customer_Name
	, M.SizeCode Locker_Type
	, M.LockerCode Locker_No
	, stuff ((select '/' + AuthName from LockerAuth a where a.BranchCode = M.BranchCode and a.LockerCode = M.LockerCode 
	  for xml path('')),1,1,'') Joint_Holder_Name1
	, NULL Joint_Holder_Cif_Id1
	, NULL Joint_Holder_Relation1
	, NULL Joint_Holder_Name2
	, NULL Joint_Holder_Cif_Id2
	, NULL Joint_Holder_Relation2
	, NULL Joint_Holder_Name3
	, NULL Joint_Holder_Cif_Id3
	, NULL Joint_Holder_Relation3
	, M.Nominee Opacc
	, NULL Sdacc
	, M.KeyNo Code_Word
	, convert(varchar(10),isnull(M.EnteredDate,'01-01-1900'),105) as Open_Date
	, convert(varchar(10),isnull(M.ReleaseDate,'01-01-1900'),105) as Closed_Date
	, 'Yr' Frequency
	, M.Rent Total_Rent
	, M.Remarks Remarks
	, convert(varchar(10),isnull(M.EnteredDate,'01-01-1900'),105) Last_Rent_Date
	, convert(varchar(10),dateadd(year,1,M.EnteredDate),105) as Due_Date
	, NULL Due_notice_Date
	, RIGHT(SPACE(17)+CAST('0' AS VARCHAR(17)),17) Due_Rent
	, 'N' Delete_Flag
	, stuff((select '/' + Remarks from LockerAuth a where a.BranchCode = M.BranchCode and a.LockerCode = M.LockerCode
	  for xml path('')),1,1,'' ) Free_Text1
	, NULL Free_Text2
	, 'T' Payment_Mode
	, convert(varchar(10),dateadd(year,1,M.EnteredDate),105) as Payment_Date
	, NULL Rent_Paid
	, NULL Preferable_Language_Code
	, NULL Customer_Name_in_Pref_Lang_Code
	, case when A.LockerCode is not null then 'ANY1S' else 'SNGLE' end Mode_of_oper_code 
	from LockerMaster M 
	join Master cif  on cif.MainCode = M.Nominee and cif.BranchCode = M.BranchCode
	left join LockerAuth A
	--left join (select top 1 LockerCode , BranchCode from LockerAuth) A 
	on A.LockerCode = M.LockerCode and A.BranchCode = M.BranchCode 
	where M.BranchCode<>'0'
	and M.LockerCode<>''
	and LEFT(cif.ClientCode , 1) <>'_'
	and cif.IsBlocked NOT IN ('C','o')
	and len(cif.MainCode) >= 8
	and (Nominee<> '9710100' or Nominee <> null)
	AND EXISTS
	(
		SELECT 1 FROM AcCustType WHERE MainCode = cif.MainCode and CustTypeCode = 'Z' and CustType NOT IN ('11','12')
	)

) as t
order by t.Cif_Id,t.SOL_ID



--select count(*) from LockerMaster